/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
class WhatsappExpressIntegration{previewEntryPointId="whatsapp-preview-adobe-express-entry-point";previewedImageClassname=["x6s0dn4 x78zum5 x5yr21d xl56j7k x6ikm8r x10wlt62 x1n2onr6 xh8yej3 xhtitgo _ao3e"];previewHeaderClassname=["x78zum5 x6s0dn4 x1afcbsf x1totv3y","x78zum5 x6s0dn4 x1afcbsf xhslqc4"];imageInMessageClassName=["x15kfjtz x1c4vz4f x2lah0s xdl72j9 x127lhb5 x4afe7t xa3vuyk x10e4vud"];gridImageClassName=[".xh8yej3.xt7dq6l"];imageInMessageOptionsClassName=["x1c4vz4f xs83m0k xdl72j9 x1g77sc7 x78zum5 xozqiw3 x1oa3qoh x12fk4p8 xeuugli x2lwn1j x1q0g3np x6s0dn4 _amj_"];imageMessageContainerSelector=["._amjv"];imageInMessageLeft=["x1nhvcw1"];imageInMessageRight=["x13a6bvl"];mainPanelSelector=["#main"];shouldShowHoverCTA=!0;touchpoint="whatsappPreview";hoverTouchpoint="whatsappHover";whatsappExpressStateKey="whatsappExpressState";minified=!1;launchExpress=(e,t,s)=>{chrome.runtime.sendMessage({main_op:"launch-express",imgUrl:e,intent:s,touchpoint:t})};sendErrorLog=(e,t)=>{chrome.runtime.sendMessage({main_op:"log-error",log:{message:e,error:t}})};unsetHoverCTA=()=>{this.shouldShowHoverCTA=!1,this.removeAllFloatingButtons()};async loadContentScripts(){const e=chrome.runtime.getURL("content_scripts/express/single-click-cta.js"),t=chrome.runtime.getURL("content_scripts/express/express-hover-cta.js"),s=chrome.runtime.getURL("content_scripts/express/express-utils.js"),i=await Promise.all([import(e),import(t),import(s)]);this.ExpressCTAClass=i[0].default,this.ExpressHoverCTAClass=i[1].default,this.expressUtils=i[2].default,this.expressCTA=new this.ExpressCTAClass}addThumbnailAndImagePreviewerObserver=()=>{new MutationObserver(e=>{this.config.enableWhatsappPreviewExpressMenu&&this.imagePreviewerObserverHandler(),this.config.enableWhatsappHoverExpressMenu&&this.imageHoverObserverHandler(e)}).observe(document.body,{childList:!0,subtree:!0})};previewEntryPointClickHandler=e=>{if(!chrome?.runtime?.id)return void this.removePreviewEntryPoint(this.previewEntryPointId);const t=this.expressUtils.getElementsFromClassNames(document,this.previewedImageClassname)[0];if(!t||"IMG"!==t.tagName)return void this.sendErrorLog("Error executing express in whatsapp","image element not found");const s=t.src;s?(this.setTouchpointClickedForFteState(this.touchpoint),this.launchExpress(s,this.touchpoint,e)):this.sendErrorLog("Error executing express in whatsapp","image URL not found")};getValidImageUrl=e=>{const t=[];for(const s of e){const e=s.src;e&&t.push(fetch(e).then(t=>{if(t.ok)return e}))}return Promise.any(t).catch(()=>{this.sendErrorLog("Error executing express in whatsapp","image URL not found")})};floatingButtonClickHandler=async(e,t,s)=>{if(!chrome?.runtime?.id)return void this.removeAllFloatingButtons();const i=this.expressUtils.getElementsFromClassNames(t,this.imageInMessageClassName),n=await this.getValidImageUrl(i);n?(this.setTouchpointClickedForFteState(s),this.launchExpress(n,s,e)):this.sendErrorLog("Error executing express in whatsapp","image URL not found")};setTouchpointClickedForFteState=async e=>{this.removeContextualFte();let t=await chrome.storage.local.get(this.whatsappExpressStateKey);switch(t=t?.whatsappExpressState?t.whatsappExpressState:{},e){case this.touchpoint:t.previewTouchpointUsed=!0;break;case this.hoverTouchpoint:t.hoverTouchpointUsed=!0}chrome.storage.local.set({[this.whatsappExpressStateKey]:t})};minifyButtons=()=>{clearTimeout(this.minimizeHoverButtonTimeout),this.minified=!0};createHoverButton=async e=>{const t=new this.ExpressHoverCTAClass;return await t.renderButton({surface:this.hoverTouchpoint,onClickCallback:t=>this.floatingButtonClickHandler(t,e,this.hoverTouchpoint),onHideClickCallback:this.unsetHoverCTA,interactionCallback:this.minifyButtons}),t};addHoverCTAContainerMutationObserver=(e,t,s)=>{new MutationObserver(()=>{let i=0;e.childNodes.forEach(e=>{e.classList.contains(this.hoverTouchpoint)||(i+=e.offsetWidth)}),"left"===s?t.style.left=`${i+10}px`:t.style.right=`${i+10}px`}).observe(e,{childList:!0,subtree:!0})};createAndAttachHoverButton=async e=>{if(!chrome?.runtime?.id)return void this.removeAllFloatingButtons();if(0!==e.parentElement.getElementsByClassName(this.hoverTouchpoint).length)return;const t=this.expressUtils.getClosestElementBasedOnSelectors(e,this.imageMessageContainerSelector);if(!t)return;const s=await this.createHoverButton(t),i=s.getCTAElement();i.style.position="absolute";const n=this.expressUtils.getElementsFromClassNames(t,this.imageInMessageOptionsClassName)[0];if(n){if(n.classList.contains(this.imageInMessageRight))i.classList.add("right"),n.prepend(i),this.addHoverCTAContainerMutationObserver(n,i,"right");else{if(!n.classList.contains(this.imageInMessageLeft))return;this.addHoverCTAContainerMutationObserver(n,i,"left"),n.appendChild(i)}s.attachTooltip("bottom"),t.addEventListener("mouseenter",()=>{this.minified?s.minimizeButton():this.minimizeHoverButtonTimeout=setTimeout(()=>{s.minimizeButton(),this.minified=!0},5e3),this.showFloatingButtonToImageElement(s)}),t.addEventListener("mouseleave",()=>{clearTimeout(this.minimizeHoverButtonTimeout),this.hideFloatingButtonFromImageElement(s)})}};showFloatingButtonToImageElement=async e=>{this.expressUtils.sendAnalyticsEventOncePerDay([["DCBrowserExt:Express:Whatsapp:HoverEntryPoint:Shown"]]),e.showButton()};hideFloatingButtonFromImageElement=e=>{e.hideButton()};removeAllFloatingButtons=()=>{Array.from(document.getElementsByClassName(this.hoverTouchpoint)).forEach(e=>{e.parentElement.removeChild(e)})};_isImageInGrid=e=>!!this.expressUtils.getClosestElementBasedOnSelectors(e,this.gridImageClassName);_isImageInMainPanel=e=>!!this.expressUtils.getClosestElementBasedOnSelectors(e,this.mainPanelSelector);imageHoverObserverHandler=e=>{for(const t of e)if("childList"===t.type)for(const e of t.addedNodes){const t=this.expressUtils.getElementsFromClassNames(e,this.imageInMessageClassName);if(0!==t.length)for(const e of t)!this._isImageInGrid(e)&&this._isImageInMainPanel(e)&&this.shouldShowHoverCTA&&this.createAndAttachHoverButton(e)}};imagePreviewerObserverHandler=()=>{const e=this.expressUtils.getElementsFromClassNames(document,this.previewHeaderClassname)[0];if(!e)return void this.cleanup();this.removeTooltipIfFteRendered();const t=document.getElementById(this.previewEntryPointId),s=this.expressUtils.getElementsFromClassNames(document,this.previewedImageClassname)[0];s&&"IMG"===s.tagName?t||(chrome?.runtime?.id?(this.addPreviewEntryPoint(e,this.previewEntryPointId,this.previewEntryPointClickHandler),this.expressUtils.sendAnalyticsEventOncePerDay([["DCBrowserExt:Express:Whatsapp:PreviewEntryPoint:Shown"]])):this.cleanup()):this.cleanup()};addPreviewEntryPoint=async(e,t,s)=>{if(document.getElementById(t))return;const i=await this.expressCTA.renderMenuButton(s,this.touchpoint);i.id=t,e.insertBefore(i,e.firstChild),this.tooltip=this.expressCTA.attachTooltip("bottom"),chrome.runtime.sendMessage({main_op:"reRenderShowOneChild"})};removePreviewEntryPoint=e=>{const t=document.getElementById(e);t&&t.remove()};cleanup=()=>{this.removePreviewEntryPoint(this.previewEntryPointId),this.tooltip?.tooltip?.remove(),this.tooltip=null,this.removeContextualFte()};removeContextualFte=()=>{const e=document.getElementById("express-contextual-fte");e&&e.remove()};removeTooltipIfFteRendered=()=>{document.getElementById("express-contextual-fte")&&this.tooltip&&(this.tooltip.tooltip.remove(),this.tooltip=null)};init=async()=>{const e=await chrome.runtime.sendMessage({main_op:"whatsapp-express-init"});this.config=e,(this.config.enableWhatsappPreviewExpressMenu||this.config.enableWhatsappHoverExpressMenu)&&(this.previewedImageClassname=this.config.selectors?.previewedImageClassname||this.previewedImageClassname,this.previewHeaderClassname=this.config.selectors?.previewHeaderClassname||this.previewHeaderClassname,this.imageInMessageClassName=this.config.selectors?.imageInMessageClassName||this.imageInMessageClassName,this.gridImageClassName=this.config.selectors?.gridImageClassName||this.gridImageClassName,this.imageInMessageOptionsClassName=this.config.selectors?.imageInMessageOptionsClassName||this.imageInMessageOptionsClassName,this.imageMessageContainerSelector=this.config.selectors?.imageMessageContainerSelector||this.imageMessageContainerSelector,this.imageInMessageLeft=this.config.selectors?.imageInMessageLeft||this.imageInMessageLeft,this.imageInMessageRight=this.config.selectors?.imageInMessageRight||this.imageInMessageRight,this.mainPanelSelector=this.config.selectors?.mainPanelSelector||this.mainPanelSelector,await this.loadContentScripts(),this.addThumbnailAndImagePreviewerObserver())}}const whatsappExpressIntegration=new WhatsappExpressIntegration;whatsappExpressIntegration.init();