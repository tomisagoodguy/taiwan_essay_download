/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import state from"../../outlook/state.js";import SingleClickCTA from"../single-click-cta.js";import expressUtils from"../express-utils.js";class ExpressOutlookTouchpointService{previewEntryPointId="express-outlook-native-viewer-entry-point";touchpoint="outlookNativeViewer";outlookExpressStateKey="outlookExpressState";nativeViewerSelectors=["m79Ne"];imgSelectors=["bk93t"];headerSelectors=["ms-CommandBar-primaryCommand"];expressButtonSelector="cc440d50ba-express-entrypoint-button";expressButtonTextSelector="cc440d50ba-express-entrypoint-button-text";expressButtonIconSelector="cc440d50ba-express-entrypoint-button-icon";constructor(){this.nativeViewerSelectors=state?.expressConfig?.selectors?.nativeViewerSelectors||this.nativeViewerSelectors,this.imgSelectors=state?.expressConfig?.selectors?.imgSelectors||this.imgSelectors,this.headerSelectors=state?.expressConfig?.selectors?.headerSelectors||this.headerSelectors}_isImagePreviewed=()=>{const e=expressUtils.getElementsFromClassNames(document,this.nativeViewerSelectors)[0];if(!e)return null;const t=expressUtils.getElementsFromClassNames(e,this.imgSelectors)[0];if(t){const e=t.getElementsByTagName("IMG")[0];return e?.getAttribute("src")}};_removeContextualFte=()=>{const e=document.getElementById("express-contextual-fte");e&&e.remove()};_removeTooltipIfFteRendered=()=>{document.getElementById("express-contextual-fte")&&state.expressState.tooltip&&(state.expressState.tooltip.tooltip.remove(),state.expressState.tooltip=null)};_setTouchpointClickedForFteState=async()=>{this._removeContextualFte();let e=await chrome.storage.local.get(this.outlookExpressStateKey);e=e?.outlookExpressState?e.outlookExpressState:{},e.previewTouchpointUsed=!0,chrome.storage.local.set({[this.outlookExpressStateKey]:e})};_clickCallback=e=>{const t=new URL(state.expressState.imageURL);state.token&&t.searchParams.set("token",state.token);const s=t.toString();chrome.runtime.sendMessage({main_op:"launch-express",imgUrl:s,intent:e,touchpoint:this.touchpoint}),this._setTouchpointClickedForFteState()};_moveTouchpointAtEndIfNotAlreadyThere=e=>{e.nextElementSibling&&this.removeExpressTouchpoints()};toggleButtonSize=(e,t)=>{e.style.width=t?"32px":"";const s=e.getElementsByClassName(this.expressButtonTextSelector)[0],o=e.getElementsByClassName(this.expressButtonIconSelector)[0];s&&(s.style.display=t?"none":""),o&&(o.style.padding=t?"7px 9px 7px 5px":"",o.style.width=t?"32px":"")};updateButtonStyles=e=>{if(!e)return;e.style.visibility="hidden",this.toggleButtonSize(e,!1);const t=e.offsetWidth,s=window.innerWidth-t<1e3;this.toggleButtonSize(e,s),e.style.visibility="visible"};_handleResponsiveButton=e=>{const t=e.getElementsByClassName(this.expressButtonSelector)[0];this.updateButtonStyles(t),state.expressState.resizeHandler=()=>this.updateButtonStyles(t),window.addEventListener("resize",state.expressState.resizeHandler)};_addExpressTouchpoint=async()=>{const e=new SingleClickCTA,t=await e.renderMenuButton(this._clickCallback,this.touchpoint);t.id=this.previewEntryPointId;const s=expressUtils.getElementsFromClassNames(document,this.nativeViewerSelectors)[0];if(s){const o=expressUtils.getElementsFromClassNames(s,this.headerSelectors)[0];if(o&&o?.childNodes?.length>0){const s=document.createElement("div");s.style.cssText="\n                    width: 1px;\n                    height: 28px;\n                    background-color: #E5E5E5;\n                    margin: 0 8px;\n                    display: inline-block;\n                    vertical-align: middle;\n                ",s.className="cc440d50ba-express-separator",state.expressState.expressTouchpointAdded||(state.expressState.expressTouchpointAdded=!0,o.appendChild(s),o.appendChild(t),this._handleResponsiveButton(t),state.expressState.tooltip=e.attachTooltip("bottom"),chrome.runtime.sendMessage({main_op:"reRenderShowOneChild"}),expressUtils.sendAnalyticsEventOncePerDay([["DCBrowserExt:Express:Outlook:NativeViewerEntryPoint:Shown"]]))}}};addExpressOutlookTouchpoint=()=>{this._removeTooltipIfFteRendered();const e=this._isImagePreviewed();if(!e)return void this.removeExpressTouchpoints();state.expressState.imageURL!==e&&(state.expressState.imageURL=e);const t=document.getElementById(this.previewEntryPointId);t?this._moveTouchpointAtEndIfNotAlreadyThere(t):(state.expressState.expressTouchpointAdded=!1,this._addExpressTouchpoint())};removeExpressTouchpoints=()=>{const e=document.getElementById(this.previewEntryPointId);if(e){state.expressState?.resizeHandler&&(window.removeEventListener("resize",state.expressState.resizeHandler),state.expressState.resizeHandler=null),state.expressState.imageURL=null;const t=document.getElementsByClassName("cc440d50ba-express-separator")[0];t&&t.parentElement?.removeChild(t),e.parentElement?.removeChild(e)}state.expressState.tooltip?.tooltip?.remove(),state.expressState.tooltip=null,this._removeContextualFte()};processForOutlook=()=>{state.expressConfig?.enableOutlookNVExpressMenu&&(this.addExpressOutlookTouchpoint(),this.detectDarkMode())};detectDarkMode=()=>{if(document.documentElement.className.includes("dark")){const e=document.getElementById(this.previewEntryPointId);e&&e.classList.add("outlookDark")}}}const expressOutlookTouchpointService=new ExpressOutlookTouchpointService;export default expressOutlookTouchpointService;